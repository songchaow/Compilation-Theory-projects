# Lab 2 C1 interpreter

> PB15000102 王嵩超



## 随便扯几句

本次实验的思路其实还是很清晰的，只是要注意的细节过多，加上LLVM的各种API的用法从文档里确认下来需要时间(本人还是有点强迫症，喜欢确定好了再写，而不是凭直觉调用函数后，等错了再去检查)，所以就花了将近两天写代码。又由于代码量比较可观，即使有vscode实时的*IntelliSense*帮助，运行后出错的地方还是不少(估计调试时改了将近几十个地方吧)，花了半天调试。于是拖到现在。

(花两天半写完，整体来讲应该也不算慢，但我是周六才开始写。。)

我不知道这段建议会不会被仔细看。我的一个想法是：生成代码时需要设的一些flag完全可以由我们自己设计。让我们在写生成代码的逻辑时发现需要这么一个flag，再自己去到builder类里面加上去。这样所有人的实现也会更丰富多样，而不是都跟着助教设计好了的思路来(去适应别人的思路，也是有时间成本的)。



另外就是自己想到的一个insight:

> 我们只是在数组长度和全局变量初始化值这两个地方，告诉编译器这个地方得用常量表达式。
>
> 对于其他地方，编译器不会主动去判断表达式是不是常量。如函数内的一个赋值语句：
>
> ```c
> a=5*2+3;
> ```
>
> 编译器仍会生成5*2,10+3的两个运算指令。在编译时计算这些显然会更好。
>
> 我刚开始写visit函数的时候，就想过，能不能在visit表达式的时候，让编译器主动去判断是不是常量表达式(方法一样，递归下去判断有没有子表达式节点属于lval类型，如果没有，就是常量表达式)，如果是，就把这个信息告诉给上层的visit函数，上层的visit函数知道了这是一个常量表达式，就不会生成出运算指令了。
>
> 但是助教给出的框架里，不是按这么设计的，flag已经限定好了，不太方便将常量表达式的信息告诉上层。
>
> 这也就是为什么我上文说，flag让我们自己设计会比较好。



##问题记录

其实调试时发现的大多数问题都是经验性错误，多半是自己粗心导致的，没有太大的参考价值。

有些经验包括：在传参数时，如果有参数不需要(如创建call指令，不需要指明参数时)，不要轻易传入nullptr，因为可能该函数的重载版本已经考虑到了不需要某参数的情形。参数为空时的数据结构不一定是nullptr,也可能是llvm::Nonetype。

另一些遇到的问题主要是由对C++了解不够导致的，这一部分我统一记在了[`C++语法现象`](https://www.onenote.com/webapp/pages?token=MhZtQu9t6svzE1sGHK-LGL9yqns5e2FOqrZIA1lhRtpKBD8tkCeDkHMn-vfCsc64GYUTMqXRnyasCpNYyTjC-sz2tL1SPEn_0&id=636473876760584503)的一个Onenote笔记本页里面。记的非常凌乱，不过现在也没时间深究。





